# Turborepo — система для управления монорепозиторием

## Что такое Turborepo?

Turborepo — это инструмент для управления монорепозиториями (monorepo), который помогает эффективно работать с несколькими связанными пакетами и приложениями в одном репозитории. Он оптимизирует процесс сборки, кеширования и выполнения задач.

## Зачем использовать Turborepo?

1. **Быстрая сборка**: Turborepo кеширует результаты сборки и тестов, поэтому повторные запуски выполняются мгновенно
2. **Параллельное выполнение**: Turborepo автоматически определяет зависимости между пакетами и запускает задачи параллельно, где это возможно
3. **Единая кодовая база**: Все пакеты в одном месте — легче делать рефакторинг и поддерживать консистентность кода
4. **Переиспользование кода**: Общие типы, утилиты и логика вынесены в отдельные пакеты и используются в разных приложениях

## Структура монорепозитория

```
running-biomechanics-mcp/
├── turbo.json              # Конфигурация Turborepo
├── package.json            # Корневой package.json
├── packages/               # Общие пакеты
│   ├── types/              # @biomech/types - типы TypeScript
│   ├── calculators/        # @biomech/calculators - вычисления биомеханики
│   └── gigachat-client/    # @biomech/gigachat-client - клиент для GigaChat
└── apps/                   # Приложения
    └── mcp-server/         # @biomech/mcp-server - HTTP сервер + MCP сервер
```

### Отличие apps/ от packages/

- **packages/** — библиотеки и общий код, которые используются другими пакетами и приложениями. Они не запускаются самостоятельно.
- **apps/** — готовые приложения, которые можно запустить (серверы, CLI, веб-приложения). Они используют пакеты из `packages/`.

## Ключевые команды

### Установка зависимостей

```bash
bun install
```

Устанавливает все зависимости для всех пакетов и приложений в монорепозитории.

### Сборка всех пакетов

```bash
bun run build
# или
turbo build
```

Turborepo автоматически определит порядок сборки на основе зависимостей между пакетами. Например, сначала соберётся `@biomech/types`, потом `@biomech/calculators` (который зависит от types), и так далее.

### Запуск в режиме разработки

```bash
bun run dev
# или
turbo dev
```

Запускает режим разработки для всех приложений. Turborepo будет следить за изменениями и пересобирать только те пакеты, которые изменились.

### Очистка артефактов сборки

```bash
bun run clean
# или
turbo clean
```

Удаляет все папки `dist/` и кеши во всех пакетах.

## Кеширование

Turborepo автоматически кеширует результаты выполнения задач (сборка, тесты, линтинг). При повторном запуске команды с теми же входными данными Turborepo просто достанет результат из кеша — это экономит огромное количество времени.

**Как это работает:**
1. Turborepo вычисляет хеш на основе содержимого файлов, конфигурации и зависимостей
2. Если хеш совпадает с ранее выполненной задачей — результат берётся из кеша
3. Если файлы изменились — задача выполняется заново и результат кешируется

Кеш можно очистить командой:
```bash
turbo clean
```

## Как добавить новый пакет

1. Создайте папку в `packages/` или `apps/`:
   ```bash
   mkdir packages/my-new-package
   cd packages/my-new-package
   ```

2. Создайте `package.json`:
   ```json
   {
     "name": "@biomech/my-new-package",
     "version": "0.1.0",
     "private": true,
     "main": "./dist/index.js",
     "types": "./dist/index.d.ts",
     "scripts": {
       "build": "tsc",
       "dev": "tsc --watch",
       "clean": "rm -rf dist"
     },
     "dependencies": {
       "@biomech/types": "*"
     },
     "devDependencies": {
       "typescript": "^5.3.0"
     }
   }
   ```

3. Создайте `tsconfig.json` и `src/index.ts`

4. Добавьте зависимость в другие пакеты, если нужно:
   ```json
   {
     "dependencies": {
       "@biomech/my-new-package": "*"
     }
   }
   ```

5. Запустите сборку:
   ```bash
   bun run build
   ```

## Граф зависимостей

Turborepo автоматически строит граф зависимостей между пакетами на основе `dependencies` в `package.json`. Это позволяет:

- Собирать пакеты в правильном порядке
- Запускать задачи параллельно, если между пакетами нет зависимостей
- Пересобирать только те пакеты, которые зависят от изменённого пакета

**Пример графа в нашем проекте:**

```
@biomech/types (базовые типы)
    ↓
@biomech/calculators (вычисления, использует types)
    ↓
@biomech/gigachat-client (клиент GigaChat, использует types и calculators)
    ↓
@biomech/mcp-server (сервер, использует все пакеты)
```

Turborepo соберёт их именно в таком порядке. Если вы измените только `@biomech/types`, Turborepo пересоберёт все зависимые пакеты автоматически.

## Конфигурация turbo.json

Файл `turbo.json` в корне проекта определяет, как Turborepo выполняет задачи:

```json
{
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**"]
    },
    "dev": {
      "cache": false
    },
    "clean": {
      "cache": false
    }
  }
}
```

- **`dependsOn: ["^build"]`** — сначала собрать все зависимости этого пакета
- **`outputs`** — какие файлы будут закешированы
- **`cache: false`** — отключить кеширование для этой задачи

## Резюме

Turborepo делает работу с монорепозиторием быстрой и удобной:
- Автоматическое управление зависимостями
- Умное кеширование результатов сборки
- Параллельное выполнение независимых задач
- Простое добавление новых пакетов

Все команды запускаются из корня проекта, Turborepo сам разберётся, что и в каком порядке выполнять.
